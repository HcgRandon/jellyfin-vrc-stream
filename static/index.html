<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jellyfin VRC Stream - Management Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .search-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .results {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .result-item {
            border-bottom: 1px solid #eee;
            padding: 20px 0;
            display: flex;
            gap: 20px;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-image {
            flex-shrink: 0;
            width: 120px;
            height: 180px;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .result-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-content {
            flex: 1;
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .result-meta {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .result-overview {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }

        .url-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-vod {
            background: #667eea;
            color: white;
        }

        .btn-vod:hover {
            background: #5568d3;
        }

        .btn-live {
            background: #f093fb;
            color: white;
        }

        .btn-live:hover {
            background: #d87ae6;
        }

        .btn-copy {
            background: #48c774;
            color: white;
        }

        .btn-copy:hover {
            background: #3ab864;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .url-display {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            margin-top: 10px;
            word-break: break-all;
            display: none;
        }

        .url-display.show {
            display: block;
        }

        .btn-expand {
            background: #4a5568;
            color: white;
        }

        .btn-expand:hover {
            background: #2d3748;
        }

        .episodes-container {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
        }

        .episodes-container.show {
            display: block;
        }

        .episode-item {
            padding: 15px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .episode-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .section-header {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section-header:first-child {
            margin-top: 0;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 200px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-control {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: #4a5568;
            color: white;
            transition: all 0.3s;
        }

        .btn-control:hover {
            background: #2d3748;
        }

        .btn-danger {
            background: #f56565;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Jellyfin VRC Stream</h1>
            <p class="subtitle">Search media and generate streaming URLs for VRChat</p>
            <div class="stats" id="stats">
                <div class="stat-box">
                    <div class="stat-label">Active Streams</div>
                    <div class="stat-value" id="active-streams">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Cache Size</div>
                    <div class="stat-value" id="cache-size">-</div>
                </div>
            </div>
            <div class="controls">
                <button class="btn-control" onclick="viewActiveStreams()">View Active Streams</button>
                <button class="btn-control" onclick="runCleanup()">Run Cleanup</button>
                <button class="btn-control btn-danger" onclick="refreshPage()">Refresh Page</button>
            </div>
        </header>

        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search for movies or TV shows...">
        </div>

        <div class="results" id="results">
            <div class="loading">Loading recently added media...</div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const resultsDiv = document.getElementById('results');
        const baseUrl = window.location.origin;

        let searchTimeout;

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch(`${baseUrl}/`);
                const data = await response.json();
                document.getElementById('active-streams').textContent = data.active_streams;
                document.getElementById('cache-size').textContent = `${data.cache_size_mb} MB`;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        loadStats();
        setInterval(loadStats, 10000); // Update every 10s

        // Load recent media on page load
        async function loadRecent() {
            try {
                const response = await fetch(`${baseUrl}/recent`);
                const data = await response.json();

                if (data.items.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">No media found</div>';
                    return;
                }

                renderResults(data.items, 'Recently Added');
            } catch (error) {
                resultsDiv.innerHTML = `<div class="no-results">Error: ${error.message}</div>`;
            }
        }

        loadRecent();

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (query.length === 0) {
                // Load recent media when search is cleared
                loadRecent();
                return;
            }

            if (query.length < 2) {
                resultsDiv.innerHTML = '<div class="no-results">Enter at least 2 characters to search</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${baseUrl}/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    console.log('Search results:', data);

                    if (data.items.length === 0) {
                        resultsDiv.innerHTML = '<div class="no-results">No results found</div>';
                        return;
                    }

                    renderResults(data.items, 'Search Results');
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="no-results">Error: ${error.message}</div>`;
                }
            }, 500);
        });

        function renderResults(items, headerTitle = '') {
            // Sort items by type: Series, Movies
            const typeOrder = { 'Series': 0, 'Movie': 1 };
            const sorted = items.sort((a, b) => {
                const orderDiff = (typeOrder[a.type] || 999) - (typeOrder[b.type] || 999);
                if (orderDiff !== 0) return orderDiff;
                // Within same type, sort by name
                return (a.name || '').localeCompare(b.name || '');
            });

            // Group by type
            const grouped = {};
            sorted.forEach(item => {
                const type = item.type || 'Other';
                if (!grouped[type]) grouped[type] = [];
                grouped[type].push(item);
            });

            // Render sections
            let html = '';
            const sectionNames = {
                'Series': 'TV Shows',
                'Movie': 'Movies'
            };

            for (const [type, typeItems] of Object.entries(grouped)) {
                const sectionName = sectionNames[type] || type;
                const fullHeader = headerTitle ? `${headerTitle} - ${sectionName}` : sectionName;
                html += `<div class="section-header">${fullHeader}</div>`;

                typeItems.forEach(item => {
                    html += renderItem(item);
                });
            }

            resultsDiv.innerHTML = html;
        }

        function renderItem(item) {
            const title = item.type === 'Episode'
                ? `${item.series} - S${item.season}E${item.episode} - ${item.name}`
                : item.name;

            const meta = [];
            if (item.type) meta.push(item.type);
            if (item.year) meta.push(item.year);

            const imageHtml = item.image
                ? `<div class="result-image"><img src="${item.image}" alt="${item.name}"></div>`
                : '<div class="result-image"></div>';

            // Series get expand button
            if (item.type === 'Series') {
                return `
                    <div class="result-item">
                        ${imageHtml}
                        <div class="result-content">
                            <div class="result-title">${title}</div>
                            <div class="result-meta">${meta.join(' • ')}</div>
                            ${item.overview ? `<div class="result-overview">${item.overview}...</div>` : ''}
                            <div class="url-buttons">
                                <button class="btn-expand" onclick="toggleEpisodes('${item.id}', this)">Show Episodes</button>
                            </div>
                            <div class="episodes-container" id="episodes-${item.id}">
                                <div class="loading">Loading episodes...</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Movies and Episodes get generate buttons
            return `
                <div class="result-item">
                    ${imageHtml}
                    <div class="result-content">
                        <div class="result-title">${title}</div>
                        <div class="result-meta">${meta.join(' • ')}</div>
                        ${item.overview ? `<div class="result-overview">${item.overview}...</div>` : ''}
                        <div class="url-buttons">
                            <button class="btn-vod" onclick="generateUrl('${item.id}', 'vod', this)">VOD Mode</button>
                            <button class="btn-live" onclick="generateUrl('${item.id}', 'live', this)">Live Mode</button>
                        </div>
                        <div class="url-display" id="url-${item.id}"></div>
                    </div>
                </div>
            `;
        }

        async function toggleEpisodes(seriesId, button) {
            const container = document.getElementById(`episodes-${seriesId}`);

            if (container.classList.contains('show')) {
                container.classList.remove('show');
                button.textContent = 'Show Episodes';
                return;
            }

            // Load episodes if not already loaded
            if (container.dataset.loaded !== 'true') {
                try {
                    const response = await fetch(`${baseUrl}/series/${seriesId}/episodes`);
                    const data = await response.json();

                    if (data.episodes.length === 0) {
                        container.innerHTML = '<div class="no-results">No episodes found</div>';
                    } else {
                        container.innerHTML = data.episodes.map(ep => {
                            const epTitle = `S${ep.season}E${ep.episode} - ${ep.name}`;
                            const epImage = ep.image
                                ? `<div class="result-image"><img src="${ep.image}" alt="${ep.name}"></div>`
                                : '<div class="result-image"></div>';

                            return `
                                <div class="result-item episode-item">
                                    ${epImage}
                                    <div class="result-content">
                                        <div class="episode-title">${epTitle}</div>
                                        ${ep.overview ? `<div class="result-overview">${ep.overview}...</div>` : ''}
                                        <div class="url-buttons">
                                            <button class="btn-vod" onclick="generateUrl('${ep.id}', 'vod', this)">VOD Mode</button>
                                            <button class="btn-live" onclick="generateUrl('${ep.id}', 'live', this)">Live Mode</button>
                                        </div>
                                        <div class="url-display" id="url-${ep.id}"></div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }

                    container.dataset.loaded = 'true';
                } catch (error) {
                    container.innerHTML = `<div class="no-results">Error loading episodes: ${error.message}</div>`;
                }
            }

            container.classList.add('show');
            button.textContent = 'Hide Episodes';
        }

        function generateUrl(mediaId, mode, button) {
            const endpoint = mode === 'vod' ? 'media.m3u8' : 'live.m3u8';
            const url = `${baseUrl}/${endpoint}?m=${mediaId}`;

            const urlDiv = document.getElementById(`url-${mediaId}`);
            urlDiv.innerHTML = `
                ${url}
                <button class="btn-copy" onclick="copyUrl('${url}', this)" style="margin-left: 10px;">Copy</button>
            `;
            urlDiv.classList.add('show');
        }

        async function copyUrl(url, button) {
            try {
                await navigator.clipboard.writeText(url);
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            } catch (error) {
                alert('Failed to copy URL. Please copy manually: ' + url);
            }
        }

        async function viewActiveStreams() {
            try {
                const response = await fetch(`${baseUrl}/streams`);
                const data = await response.json();

                if (data.streams.length === 0) {
                    alert('No active streams');
                    return;
                }

                const streamInfo = data.streams.map(s =>
                    `${s.stream_key}\n  Media ID: ${s.media_id}\n  Mode: ${s.mode}\n  Idle: ${s.idle_seconds}s\n  Age: ${s.age_seconds}s`
                ).join('\n\n');

                alert(`Active Streams (${data.streams.length}):\n\n${streamInfo}\n\nCache Size: ${data.cache_size_mb} MB`);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function runCleanup() {
            if (!confirm('Run manual cleanup? This will remove idle streams and free up cache space.')) {
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/cleanup`, { method: 'POST' });
                const data = await response.json();

                alert(`Cleanup complete!\n\nIdle streams removed: ${data.removed_idle}\nSize-based removals: ${data.removed_size}\nCache size: ${data.cache_size_mb} MB`);

                // Refresh stats
                loadStats();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function refreshPage() {
            location.reload();
        }
    </script>
</body>
</html>
